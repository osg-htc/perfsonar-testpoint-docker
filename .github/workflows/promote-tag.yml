name: Promote tag (production/test) without rebuild

on:
  workflow_dispatch:
    inputs:
      source_tag:
        description: "Existing tag to promote (e.g., a version or 'latest')"
        required: true
        default: "latest"
      target_tag:
        description: "Target tag to apply (production or test)"
        required: true
        type: choice
        options:
          - production
          - test

env:
  REGISTRY: hub.opensciencegrid.org
  IMAGE_REPO: osg-htc/perfsonar-testpoint

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - name: Install crane
        uses: imjasonh/setup-crane@v0.3

      - name: Login to Harbor
        run: |
          crane auth login "$REGISTRY" \
            -u "${{ secrets.OSG_HARBOR_ROBOT_USER }}" \
            -p "${{ secrets.OSG_HARBOR_ROBOT_PASSWORD }}"

      - name: Copy tag by digest (no rebuild)
        env:
          SOURCE_TAG: ${{ github.event.inputs.source_tag }}
          TARGET_TAG: ${{ github.event.inputs.target_tag }}
        run: |
          set -eo pipefail
          SRC="${REGISTRY}/${IMAGE_REPO}:${SOURCE_TAG}"
          DST="${REGISTRY}/${IMAGE_REPO}:${TARGET_TAG}"
          echo "Promoting ${SRC} -> ${DST}"
          crane copy "$SRC" "$DST"

      - name: Verify promoted tag
        env:
          TARGET_TAG: ${{ github.event.inputs.target_tag }}
        run: |
          set -eo pipefail
          echo "Digest of ${REGISTRY}/${IMAGE_REPO}:${TARGET_TAG}:"
          crane digest "${REGISTRY}/${IMAGE_REPO}:${TARGET_TAG}"
