name: Build and push patched perfSONAR Testpoint

"on":
  workflow_dispatch:
    inputs:
      upstream_ref:
        description: "Upstream ref (tag or branch) to build from (blank = default branch)"
        required: false
        default: ""
      force_version:
        description: "Force final published version (override OCI label & VERSION)"
        required: false
        default: ""
      env_tag:
        description: "Optional environment tag to also apply (production/test/none)"
        required: false
        default: "none"
  schedule:
    - cron: "23 6 * * *"

env:
  REGISTRY: hub.opensciencegrid.org
  IMAGE_REPO: osg-htc/perfsonar-testpoint

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Clone upstream source
        shell: bash
        run: |
          set -eux
          REF="${{ github.event.inputs.upstream_ref }}"
          if [ -n "${REF}" ]; then
            git clone --depth=1 --branch "${REF}" \
              https://github.com/perfsonar/perfsonar-testpoint-docker upstream
          else
            git clone --depth=1 \
              https://github.com/perfsonar/perfsonar-testpoint-docker upstream
          fi

      - name: Determine version from upstream
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          VERSION=""
          if [ -f upstream/VERSION ]; then
            VERSION="$(tr -d ' \n' < upstream/VERSION)"
          fi
          if [ -z "$VERSION" ]; then
            VERSION="$(git -C upstream describe --tags --abbrev=0 2>/dev/null || true)"
          fi
          if [ -z "$VERSION" ]; then
            VERSION="$(date -u +%Y.%m.%d)"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Log version
        shell: bash
        run: |
          echo "Building upstream version: ${{ steps.meta.outputs.version }}"

      - name: Build upstream image locally
        shell: bash
        run: |
          META='${{ steps.meta.outputs.version }}'
          docker build -t "local/perfsonar-testpoint:${META}" ./upstream

      - name: Select final version (respect forced override)
        id: version_select
        shell: bash
        run: |
          set -euo pipefail
          META='${{ steps.meta.outputs.version }}'
          UPSTREAM_REF='${{ github.event.inputs.upstream_ref }}'
          FORCE='${{ github.event.inputs.force_version }}'
          echo "Derived META version: $META"
          echo "User upstream_ref: $UPSTREAM_REF"
          echo "User force_version: $FORCE"

          # If user forces a version, take it directly.
          if [ -n "$FORCE" ]; then
            echo "Using forced version: $FORCE"
            echo "version=$FORCE" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Helper matchers
          is_semver_like() {
            echo "$1" | grep -Eq '^[v]?[0-9]+\.[0-9]+\.[0-9]+(-systemd)?$'
          }
          is_perfsonar_label() {
            echo "$1" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+(-systemd)?$'
          }
          is_distro_label() {
            echo "$1" | grep -Eq '^[0-9]+\.[0-9]+$'
          }

          CHOSEN="${META#v}"

          # If upstream_ref looks like a perfSONAR tag, prefer it over META
          if [ -n "$UPSTREAM_REF" ] && is_semver_like "$UPSTREAM_REF"; then
            CHOSEN="${UPSTREAM_REF#v}"
            echo "Using upstream_ref as base version: $CHOSEN"
          fi

          # Try OCI label from the locally built upstream image
          RAW_LABEL="$(docker inspect local/perfsonar-testpoint:${META} \
            --format '{{ index .Config.Labels "org.opencontainers.image.version" }}' 2>/dev/null || true)"
          echo "Raw OCI label: '${RAW_LABEL}'"

          if [ -n "$RAW_LABEL" ] && [ "$RAW_LABEL" != "<no value>" ]; then
            if is_perfsonar_label "$RAW_LABEL"; then
              CHOSEN="$RAW_LABEL"
              echo "Using OCI label as final version: $CHOSEN"
            elif is_distro_label "$RAW_LABEL"; then
              echo "Ignoring OCI label '$RAW_LABEL' (distro-style version)"
            else
              echo "Ignoring OCI label '$RAW_LABEL' (unrecognized pattern)"
            fi
          fi

          echo "Final chosen version: $CHOSEN"
          echo "version=$CHOSEN" >> "$GITHUB_OUTPUT"

      - name: Verify required patch files exist
        shell: bash
        run: |
          [ -f Dockerfile.patched ] || { echo "Dockerfile.patched missing"; exit 1; }
          [ -f patches/osg-restrictions.conf ] || { echo "patches/osg-restrictions.conf missing"; exit 1; }

      - name: Build patched image
        shell: bash
        run: |
          set -eux
          META='${{ steps.meta.outputs.version }}'
          FINAL='${{ steps.version_select.outputs.version }}'
          EXTRA_TAG=""
          if [ "${{ github.event.inputs.env_tag }}" != "" ] && [ "${{ github.event.inputs.env_tag }}" != "none" ]; then
            EXTRA_TAG="-t ${REGISTRY}/${IMAGE_REPO}:${{ github.event.inputs.env_tag }}"
          fi
          docker build \
            --build-arg BASE_IMAGE="local/perfsonar-testpoint:${META}" \
            -f Dockerfile.patched \
            -t "${REGISTRY}/${IMAGE_REPO}:${FINAL}" \
            -t "${REGISTRY}/${IMAGE_REPO}:latest" \
            ${EXTRA_TAG} \
            .

      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.OSG_HARBOR_ROBOT_USER }}
          password: ${{ secrets.OSG_HARBOR_ROBOT_PASSWORD }}

      - name: Push version tag
        shell: bash
        run: docker push "${REGISTRY}/${IMAGE_REPO}:${{ steps.version_select.outputs.version }}"

      - name: Push latest tag
        shell: bash
        run: docker push "${REGISTRY}/${IMAGE_REPO}:latest"

      - name: Push env tag (production/test) if requested
        if: ${{ github.event.inputs.env_tag != '' && github.event.inputs.env_tag != 'none' }}
        shell: bash
        run: docker push "${REGISTRY}/${IMAGE_REPO}:${{ github.event.inputs.env_tag }}"
