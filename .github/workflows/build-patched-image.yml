name: Build and push patched perfSONAR Testpoint (minimal, single-arch)

"on":
  workflow_dispatch:
    inputs:
      upstream_tag:
        description: "Upstream tag to build from (e.g. v5.2.3 or 5.2.3). Blank = default branch."
        required: false
        default: "v5.2.3"
      variant:
        description: "Base variant (systemd|supervisord). Minimal workflow builds single-arch only."
        required: false
        default: "systemd"
      force_version:
        description: "Force final version tag (override auto logic)"
        required: false
        default: ""
      env_tag:
        description: "Optional extra tag to also publish (e.g. production, test, or none)"
        required: false
        default: "none"

env:
  REGISTRY: hub.opensciencegrid.org
  IMAGE_REPO: osg-htc/perfsonar-testpoint

concurrency:
  group: patched-perfsonar-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve upstream tag (accepts plain or v-prefixed)
        id: resolve_tag
        shell: bash
        run: |
          set -euo pipefail
          REPO="https://github.com/perfsonar/perfsonar-testpoint-docker"
          INPUT='${{ github.event.inputs.upstream_tag }}'
          if [ -z "$INPUT" ]; then
            echo "No upstream_tag supplied; using default branch."
            echo "resolved=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if git ls-remote --tags "$REPO" | grep -q "refs/tags/${INPUT}$"; then
            RES="$INPUT"
          elif [[ "$INPUT" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-systemd)?$ ]] && \
               git ls-remote --tags "$REPO" | grep -q "refs/tags/v${INPUT}$"; then
            RES="v${INPUT}"
          else
            echo "ERROR: Upstream tag '${INPUT}' not found (exact or v-prefixed)." >&2
            git ls-remote --tags "$REPO" | awk -F/ '{print $NF}' | tail -n 20 >&2
            exit 1
          fi
          echo "resolved=$RES" >> "$GITHUB_OUTPUT"
          echo "Resolved upstream tag: $RES"

      - name: Clone upstream source
        shell: bash
        run: |
          set -eux
          REPO="https://github.com/perfsonar/perfsonar-testpoint-docker"
          TAG='${{ steps.resolve_tag.outputs.resolved }}'
          if [ -z "$TAG" ]; then
            git clone --depth=1 "$REPO" upstream
          else
            git init upstream
            git -C upstream remote add origin "$REPO"
            git -C upstream fetch --depth=1 origin "refs/tags/$TAG:refs/tags/$TAG"
            git -C upstream checkout -q "tags/$TAG"
          fi
          git -C upstream rev-parse --short HEAD

      - name: Determine meta version (for tagging)
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          TAG='${{ steps.resolve_tag.outputs.resolved }}'
          VERSION=""
          [ -n "$TAG" ] && VERSION="${TAG#v}"
          if [ -z "$VERSION" ] && [ -f upstream/VERSION ]; then
            VERSION="$(tr -d ' \n' < upstream/VERSION)"
          fi
          if [ -z "$VERSION" ]; then
            VERSION="$(git -C upstream describe --tags --abbrev=0 2>/dev/null | sed 's/^v//' || true)"
          fi
          if [ -z "$VERSION" ]; then
            VERSION="$(date -u +%Y.%m.%d)"
          fi
          echo "meta=$VERSION" >> "$GITHUB_OUTPUT"
          echo "META version: $VERSION"

      - name: Select final published version
        id: final
        shell: bash
        run: |
          set -euo pipefail
          FORCE='${{ github.event.inputs.force_version }}'
          META='${{ steps.meta.outputs.meta }}'
          if [ -n "$FORCE" ]; then
            FINAL="$FORCE"
          else
            FINAL="$META"
          fi
          if [ -z "$FORCE" ] && echo "$FINAL" | grep -Eq '^[0-9]+\.[0-9]+$'; then
            echo "ERROR: Version '$FINAL' looks like a distro release; override with force_version." >&2
            exit 1
          fi
          echo "version=$FINAL" >> "$GITHUB_OUTPUT"
          echo "Final version: $FINAL"

      - name: Show parameters
        shell: bash
        run: |
          echo "Upstream tag:        '${{ steps.resolve_tag.outputs.resolved }}'"
          echo "META version:        '${{ steps.meta.outputs.meta }}'"
          echo "Final version:       '${{ steps.final.outputs.version }}'"
          echo "Variant:             '${{ github.event.inputs.variant }}'"

      - name: Build upstream base image (single-arch, classic docker)
        shell: bash
        run: |
          set -eux
          VARIANT='${{ github.event.inputs.variant }}'
          META='${{ steps.meta.outputs.meta }}'
          DOCKERFILE="Dockerfile"
          case "$VARIANT" in
            systemd) DOCKERFILE="systemd/Dockerfile" ;;
            supervisord) DOCKERFILE="Dockerfile" ;;
            *) echo "Invalid variant '$VARIANT' (must be systemd or supervisord)"; exit 1 ;;
          esac
          docker build \
            -f "upstream/${DOCKERFILE}" \
            -t "local/perfsonar-testpoint:${META}" \
            upstream

      - name: Verify upstream image exists locally
        shell: bash
        run: |
          set -euo pipefail
          META='${{ steps.meta.outputs.meta }}'
          docker image inspect "local/perfsonar-testpoint:${META}" >/dev/null
          echo "Local images:"
          docker images --format '{{.Repository}}:{{.Tag}}' | grep '^local/perfsonar-testpoint' || true

      - name: Verify patch artifacts exist
        shell: bash
        run: |
          [ -f Dockerfile.patched ] || { echo "Missing Dockerfile.patched"; exit 1; }
          [ -f patches/osg-restrictions.conf ] || { echo "Missing patches/osg-restrictions.conf"; exit 1; }

      - name: Build patched image (single-arch, classic docker)
        shell: bash
        run: |
          set -eux
          META='${{ steps.meta.outputs.meta }}'
          FINAL='${{ steps.final.outputs.version }}'
          EXTRA_TAG=""
          if [ "${{ github.event.inputs.env_tag }}" != "" ] && [ "${{ github.event.inputs.env_tag }}" != "none" ]; then
            EXTRA_TAG="-t ${REGISTRY}/${IMAGE_REPO}:${{ github.event.inputs.env_tag }}"
          fi
          docker build \
            --build-arg BASE_IMAGE="local/perfsonar-testpoint:${META}" \
            --build-arg PATCH_REV="${{ github.run_number }}" \
            -f Dockerfile.patched \
            -t "${REGISTRY}/${IMAGE_REPO}:${FINAL}" \
            -t "${REGISTRY}/${IMAGE_REPO}:latest" \
            ${EXTRA_TAG} \
            .

      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.OSG_HARBOR_ROBOT_USER }}
          password: ${{ secrets.OSG_HARBOR_ROBOT_PASSWORD }}

      - name: Push patched images
        shell: bash
        run: |
          set -eux
          FINAL='${{ steps.final.outputs.version }}'
          docker push "${REGISTRY}/${IMAGE_REPO}:${FINAL}"
          docker push "${REGISTRY}/${IMAGE_REPO}:latest"
          if [ "${{ github.event.inputs.env_tag }}" != "" ] && [ "${{ github.event.inputs.env_tag }}" != "none" ]; then
            docker push "${REGISTRY}/${IMAGE_REPO}:${{ github.event.inputs.env_tag }}"
          fi

      - name: Summary
        shell: bash
        run: |
          echo "Upstream tag:   '${{ steps.resolve_tag.outputs.resolved }}'"
          echo "Published tags: '${{ steps.final.outputs.version }}', 'latest'${{ github.event.inputs.env_tag != '' && github.event.inputs.env_tag != 'none' && format(', {0}', github.event.inputs.env_tag) || '' }}"
