name: Build and push patched perfSONAR Testpoint

on:
  workflow_dispatch:
    inputs:
      upstream_ref:
        description: "Upstream ref (tag or branch) to build from (empty = default branch)"
        required: false
        default: ""
      env_tag:
        description: "Optional environment tag to also apply (production/test/none)"
        required: false
        default: "none"
  schedule:
    # Optional: check daily for new upstream changes (you can remove if undesired)
    - cron: "23 6 * * *"

env:
  REGISTRY: hub.opensciencegrid.org
  IMAGE_REPO: osg-htc/perfsonar-testpoint

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Clone upstream source
        run: |
          set -eux
          REF="${{ github.event.inputs.upstream_ref }}"
          if [ -n "${REF}" ]; then
            git clone --depth=1 --branch "${REF}" https://github.com/perfsonar/perfsonar-testpoint-docker upstream
          else
            git clone --depth=1 https://github.com/perfsonar/perfsonar-testpoint-docker upstream
          fi

      - name: Determine version from upstream
        id: meta
        run: |
          set -euo pipefail
          VERSION=""
          # Prefer a VERSION file if upstream provides one
          if [ -f upstream/VERSION ]; then
            VERSION="$(tr -d ' \n' < upstream/VERSION)"
          fi
          # Fall back to latest annotated tag
          if [ -z "$VERSION" ]; then
            VERSION="$(git -C upstream describe --tags --abbrev=0 2>/dev/null || true)"
          fi
          # Fallback if no tags exist (use date)
          if [ -z "$VERSION" ]; then
            VERSION="$(date -u +%Y.%m.%d)"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Log version
        run: |
          echo "Building upstream version: ${{ steps.meta.outputs.version }}"

      - name: Build upstream image locally
        run: |
          docker build -t local/perfsonar-testpoint:${{ steps.meta.outputs.version }} ./upstream

      - name: Optional: Prefer upstream OCI version label if present
        id: readlabel
        run: |
          set -euo pipefail
          # Try to read org.opencontainers.image.version from the upstream build
          LABEL_VERSION="$(docker inspect local/perfsonar-testpoint:${{ steps.meta.outputs.version }} \
            --format '{{ index .Config.Labels "org.opencontainers.image.version" }}' || true)"
          if [ -n "$LABEL_VERSION" ] && [ "$LABEL_VERSION" != "<no value>" ]; then
            echo "Using version label from upstream image: $LABEL_VERSION"
            echo "version=$LABEL_VERSION" > version_override.env
          else
            echo "version=${{ steps.meta.outputs.version }}" > version_override.env
          fi
        shell: bash

      - name: Export final version
        id: finalver
        run: |
          source version_override.env
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Build patched image
        run: |
          docker build \
            --build-arg BASE_IMAGE=local/perfsonar-testpoint:${{ steps.finalver.outputs.version }} \
            -f Dockerfile.patched \
            -t ${REGISTRY}/${IMAGE_REPO}:${{ steps.finalver.outputs.version }} \
            -t ${REGISTRY}/${IMAGE_REPO}:latest \
            $( if [ "${{ github.event.inputs.env_tag }}" != "" ] && [ "${{ github.event.inputs.env_tag }}" != "none" ]; then \
                  echo "-t ${REGISTRY}/${IMAGE_REPO}:${{ github.event.inputs.env_tag }}"; \
               fi ) \
            .

      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Push version tag
        run: docker push ${REGISTRY}/${IMAGE_REPO}:${{ steps.finalver.outputs.version }}

      - name: Push latest tag
        run: docker push ${REGISTRY}/${IMAGE_REPO}:latest

      - name: Push env tag (production/test) if requested
        if: ${{ github.event.inputs.env_tag && github.event.inputs.env_tag != 'none' }}
        run: docker push ${REGISTRY}/${IMAGE_REPO}:${{ github.event.inputs.env_tag }}
