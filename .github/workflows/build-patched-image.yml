name: Build and push patched perfSONAR Testpoint

"on":
  workflow_dispatch:
    inputs:
      upstream_ref:
        description: "Upstream ref (tag or branch) to build from (blank = default branch)"
        required: false
        default: ""
      env_tag:
        description: "Optional environment tag to also apply (production/test/none)"
        required: false
        default: "none"
  schedule:
    - cron: "23 6 * * *"

env:
  REGISTRY: hub.opensciencegrid.org
  IMAGE_REPO: osg-htc/perfsonar-testpoint

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Clone upstream source
        shell: bash
        run: |
          set -eux
          REF="${{ github.event.inputs.upstream_ref }}"
          if [ -n "${REF}" ]; then
            git clone --depth=1 --branch "${REF}" \
              https://github.com/perfsonar/perfsonar-testpoint-docker upstream
          else
            git clone --depth=1 \
              https://github.com/perfsonar/perfsonar-testpoint-docker upstream
          fi

      - name: Determine version from upstream
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          VERSION=""
          if [ -f upstream/VERSION ]; then
            VERSION="$(tr -d ' \n' < upstream/VERSION)"
          fi
          if [ -z "$VERSION" ]; then
            VERSION="$(git -C upstream describe --tags --abbrev=0 2>/dev/null || true)"
          fi
          if [ -z "$VERSION" ]; then
            VERSION="$(date -u +%Y.%m.%d)"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Log version
        shell: bash
        run: |
          echo "Building upstream version: ${{ steps.meta.outputs.version }}"

      - name: Build upstream image locally
        shell: bash
        run: |
          META='${{ steps.meta.outputs.version }}'
          docker build -t "local/perfsonar-testpoint:${META}" ./upstream

      - name: Prefer upstream OCI version label if present
        id: readlabel
        shell: bash
        run: |
          set -euo pipefail
          LABEL_VERSION="$(docker inspect \
            local/perfsonar-testpoint:${{ steps.meta.outputs.version }} \
            --format '{{ index .Config.Labels "org.opencontainers.image.version" }}' \
            2>/dev/null || true)"
          if [ -n "$LABEL_VERSION" ] && [ "$LABEL_VERSION" != "<no value>" ]; then
            echo "Using upstream image label: $LABEL_VERSION"
            echo "version=$LABEL_VERSION" > version_override.env
          else
            echo "version=${{ steps.meta.outputs.version }}" > version_override.env
          fi

      - name: Export final version
        id: finalver
        shell: bash
        run: |
          source version_override.env
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Ensure local base tags exist (meta and final)
        shell: bash
        run: |
          set -euo pipefail
          META='${{ steps.meta.outputs.version }}'
          FINAL='${{ steps.finalver.outputs.version }}'
          docker image inspect "local/perfsonar-testpoint:${META}" >/dev/null
          if [ "${FINAL}" != "${META}" ]; then
            docker tag "local/perfsonar-testpoint:${META}" "local/perfsonar-testpoint:${FINAL}"
          fi

      - name: Verify required patch files exist
        shell: bash
        run: |
          [ -f Dockerfile.patched ] || { echo "Dockerfile.patched missing"; exit 1; }
          [ -f patches/default-ssl.conf.patch ] || { echo "patches/default-ssl.conf.patch missing"; exit 1; }

      - name: Build patched image
        shell: bash
        run: |
          set -eux
          META='${{ steps.meta.outputs.version }}'
          FINAL='${{ steps.finalver.outputs.version }}'
          EXTRA_TAG=""
          if [ "${{ github.event.inputs.env_tag }}" != "" ] && [ "${{ github.event.inputs.env_tag }}" != "none" ]; then
            EXTRA_TAG="-t ${REGISTRY}/${IMAGE_REPO}:${{ github.event.inputs.env_tag }}"
          fi
          docker build \
            --build-arg BASE_IMAGE="local/perfsonar-testpoint:${META}" \
            -f Dockerfile.patched \
            -t "${REGISTRY}/${IMAGE_REPO}:${FINAL}" \
            -t "${REGISTRY}/${IMAGE_REPO}:latest" \
            ${EXTRA_TAG} \
            .

      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Push version tag
        shell: bash
        run: docker push "${REGISTRY}/${IMAGE_REPO}:${{ steps.finalver.outputs.version }}"

      - name: Push latest tag
        shell: bash
        run: docker push "${REGISTRY}/${IMAGE_REPO}:latest"

      - name: Push env tag (production/test) if requested
        if: ${{ github.event.inputs.env_tag != '' && github.event.inputs.env_tag != 'none' }}
        shell: bash
        run: docker push "${REGISTRY}/${IMAGE_REPO}:${{ github.event.inputs.env_tag }}"
